{"version":3,"sources":["../../../../lib/stream/xlsx/workbook-reader.js"],"names":["fs","require","events","Stream","unzip","Sax","tmp","utils","FlowControl","StyleManager","WorkbookPropertiesManager","WorksheetReader","HyperlinkReader","setGracefulCleanup","WorkbookReader","module","exports","options","styles","init","properties","worksheetReaders","hyperlinkReaders","readers","atEnd","waitingWorkSheets","tempFileCleanupCallbacks","inherits","EventEmitter","_getStream","input","Readable","createReadStream","Error","flowControl","_flowControl","entries","sharedStrings","hyperlinks","worksheets","read","stream","zip","Parse","self","saxClose","once","emit","on","match","sheetNo","entry","path","autodrain","_parseWorkbook","_parseSharedStrings","_parseStyles","_parseWorksheet","file","_tempFileCreated","err","fd","cleanupCallback","tempStream","createWriteStream","push","pipe","_parseHyperlinks","length","currentBook","processBooks","worksheetInfo","worksheet","node","forEach","cb","setImmediate","_emitEntry","payload","type","parseStream","parser","createStream","inT","t","index","name","text","error","_getReader","Type","collection","reader","id","worksheetReader","hyperlinksReader"],"mappings":"AAAA;;;;;;AAMA;;AAEA,IAAIA,KAAKC,QAAQ,IAAR,CAAT;AACA,IAAIC,SAASD,QAAQ,QAAR,CAAb;AACA,IAAIE,SAASF,QAAQ,QAAR,CAAb;AACA,IAAIG,QAAQH,QAAQ,UAAR,CAAZ;AACA,IAAII,MAAMJ,QAAQ,KAAR,CAAV;AACA,IAAIK,MAAML,QAAQ,KAAR,CAAV;;AAEA,IAAIM,QAAQN,QAAQ,mBAAR,CAAZ;AACA,IAAIO,cAAcP,QAAQ,0BAAR,CAAlB;;AAEA,IAAIQ,eAAeR,QAAQ,qCAAR,CAAnB;AACA,IAAIS,4BAA4BT,QAAQ,iDAAR,CAAhC;;AAEA,IAAIU,kBAAkBV,QAAQ,oBAAR,CAAtB;AACA,IAAIW,kBAAkBX,QAAQ,oBAAR,CAAtB;;AAEAK,IAAIO,kBAAJ;;AAEA,IAAIC,iBAAiBC,OAAOC,OAAP,GAAiB,UAASC,OAAT,EAAkB;AACtD,OAAKA,OAAL,GAAeA,UAAUA,WAAW,EAApC;;AAEA,OAAKC,MAAL,GAAc,IAAIT,YAAJ,EAAd;AACA,OAAKS,MAAL,CAAYC,IAAZ;;AAEA,OAAKC,UAAL,GAAkB,IAAIV,yBAAJ,EAAlB;;AAEA;AACA,OAAKW,gBAAL,GAAwB,EAAxB;;AAEA;AACA,OAAKC,gBAAL,GAAwB,EAAxB;;AAEA;AACA,OAAKC,OAAL,GAAe,CAAf;;AAEA;AACA,OAAKC,KAAL,GAAa,KAAb;;AAEA;AACA,OAAKC,iBAAL,GAAyB,EAAzB;;AAEA;AACA,OAAKC,wBAAL,GAAgC,EAAhC;AACD,CAzBD;;AA2BAnB,MAAMoB,QAAN,CAAeb,cAAf,EAA+BZ,OAAO0B,YAAtC,EAAoD;AAClDC,cAAY,oBAASC,KAAT,EAAgB;AAC1B,QAAIA,iBAAiB3B,OAAO4B,QAA5B,EAAsC;AACpC,aAAOD,KAAP;AACD;AACD,QAAI,OAAOA,KAAP,KAAiB,QAArB,EAA+B;AAC7B,aAAO9B,GAAGgC,gBAAH,CAAoBF,KAApB,CAAP;AACD;AACD,UAAM,IAAIG,KAAJ,CAAU,2BAAV,CAAN;AACD,GATiD;;AAWlD,MAAIC,WAAJ,GAAkB;AAChB,QAAI,CAAC,KAAKC,YAAV,EAAwB;AACtB,WAAKA,YAAL,GAAoB,IAAI3B,WAAJ,CAAgB,KAAKS,OAArB,CAApB;AACD;AACD,WAAO,KAAKkB,YAAZ;AACD,GAhBiD;;AAkBlDlB,WAAS;AACPmB,aAAS,CAAC,MAAD,CADF;AAEPC,mBAAe,CAAC,OAAD,EAAU,MAAV,CAFR;AAGPnB,YAAQ,CAAC,OAAD,CAHD;AAIPoB,gBAAY,CAAC,OAAD,EAAU,MAAV,CAJL;AAKPC,gBAAY,CAAC,MAAD;AALL,GAlByC;AAyBlDC,QAAM,cAASV,KAAT,EAAgBb,OAAhB,EAAyB;AAAA;;AAC7B,QAAIwB,SAAS,KAAKA,MAAL,GAAc,KAAKZ,UAAL,CAAgBC,KAAhB,CAA3B;AACA,QAAIY,MAAM,KAAKA,GAAL,GAAWtC,MAAMuC,KAAN,EAArB;AACA,QAAIC,OAAO,IAAX;;AAEA,QAAMC,WAAW,IAAI3C,OAAO0B,YAAX,EAAjB;AACAa,WAAOK,IAAP,CAAY,OAAZ,EAAqB,YAAW;AAC9BD,eAASE,IAAT,CAAc,OAAd;AACD,KAFD;;AAIAL,QAAIM,EAAJ,CAAO,OAAP,EAAgB,iBAAS;AACvB,UAAIC,KAAJ,EAAWC,OAAX;AACA;AACA,cAAQC,MAAMC,IAAd;AACE,aAAK,aAAL;AACA,aAAK,4BAAL;AACED,gBAAME,SAAN;AACA;AACF,aAAK,iBAAL;AACE,gBAAKC,cAAL,CAAoBH,KAApB,EAA2BlC,OAA3B;AACA;AACF,aAAK,sBAAL;AACE,gBAAKsC,mBAAL,CAAyBJ,KAAzB,EAAgClC,OAAhC;AACA;AACF,aAAK,eAAL;AACE,gBAAKuC,YAAL,CAAkBL,KAAlB,EAAyBlC,OAAzB;AACA;AACF;AACE,cAAIkC,MAAMC,IAAN,CAAWH,KAAX,CAAiB,gCAAjB,CAAJ,EAAwD;AACtDA,oBAAQE,MAAMC,IAAN,CAAWH,KAAX,CAAiB,kCAAjB,CAAR;AACAC,sBAAUD,MAAM,CAAN,CAAV;AACA,gBAAI,MAAKZ,aAAT,EAAwB;AACtB,oBAAKoB,eAAL,CAAqBN,KAArB,EAA4BD,OAA5B,EAAqCjC,OAArC,EAA8C4B,QAA9C;AACD,aAFD,MAEO;AACL;AACAvC,kBAAIoD,IAAJ,CAAS,SAASC,gBAAT,CAA0BC,GAA1B,EAA+BR,IAA/B,EAAqCS,EAArC,EAAyCC,eAAzC,EAA0D;AACjE,oBAAIF,GAAJ,EAAS,MAAMA,GAAN;;AAET,oBAAIG,aAAa/D,GAAGgE,iBAAH,CAAqBZ,IAArB,CAAjB;;AAEAR,qBAAKnB,iBAAL,CAAuBwC,IAAvB,CAA4B,EAACf,SAASA,OAAV,EAAmBjC,SAASA,OAA5B,EAAqCmC,MAAMA,IAA3C,EAA5B;AACAD,sBAAMe,IAAN,CAAWH,UAAX;;AAEAnB,qBAAKlB,wBAAL,CAA8BuC,IAA9B,CAAmCH,eAAnC;AACD,eATD;AAUD;AACF,WAlBD,MAkBO,IAAIX,MAAMC,IAAN,CAAWH,KAAX,CAAiB,4CAAjB,CAAJ,EAAoE;AACzEA,oBAAQE,MAAMC,IAAN,CAAWH,KAAX,CAAiB,8CAAjB,CAAR;AACAC,sBAAUD,MAAM,CAAN,CAAV;AACA,kBAAKkB,gBAAL,CAAsBhB,KAAtB,EAA6BD,OAA7B,EAAsCjC,OAAtC,EAA+C4B,QAA/C;AACD,WAJM,MAIA;AACLM,kBAAME,SAAN;AACD;AACD;AAxCJ;AA0CD,KA7CD;;AA+CAX,QAAIM,EAAJ,CAAO,OAAP,EAAgB,YAAM;AACpB,UAAIJ,KAAKnB,iBAAL,CAAuB2C,MAA3B,EAAmC;AAC/B,YAAIC,cAAc,CAAlB;;AAEA,YAAIC,eAAe,SAAfA,YAAe,GAAY;AAC3B,cAAIC,gBAAgB3B,KAAKnB,iBAAL,CAAuB4C,WAAvB,CAApB;AACA,cAAIlB,QAAQnD,GAAGgC,gBAAH,CAAoBuC,cAAcnB,IAAlC,CAAZ;;AAEA,cAAIF,UAAUqB,cAAcrB,OAA5B;AACA,cAAIjC,UAAUsD,cAActD,OAA5B;AACA,cAAIuD,YAAY5B,KAAKa,eAAL,CAAqBN,KAArB,EAA4BD,OAA5B,EAAqCjC,OAArC,EAA8C4B,QAA9C,CAAhB;;AAEA2B,oBAAUxB,EAAV,CAAa,UAAb,EAAyB,UAAUyB,IAAV,EAAgB;AACrC,cAAEJ,WAAF;AACA,gBAAIA,gBAAgBzB,KAAKnB,iBAAL,CAAuB2C,MAA3C,EAAmD;AACjD;AACAxB,mBAAKlB,wBAAL,CAA8BgD,OAA9B,CAAsC,UAAUC,EAAV,EAAc;AAClDA;AACD,eAFD;;AAIA/B,mBAAKlB,wBAAL,GAAgC,EAAhC;;AAEAkB,mBAAKG,IAAL,CAAU,KAAV;AACAH,mBAAKpB,KAAL,GAAa,IAAb;AACA,kBAAI,CAACoB,KAAKrB,OAAV,EAAmB;AACjBqB,qBAAKG,IAAL,CAAU,UAAV;AACD;AACF,aAbD,MAaO;AACH6B,2BAAaN,YAAb;AACH;AACJ,WAlBD;AAmBH,SA3BD;AA4BAM,qBAAaN,YAAb;AACH,OAhCD,MAgCO;AACH,cAAKvB,IAAL,CAAU,KAAV;AACA,cAAKvB,KAAL,GAAa,IAAb;AACA,YAAI,CAAC,MAAKD,OAAV,EAAmB;AACf,gBAAKwB,IAAL,CAAU,UAAV;AACH;AACJ;AAGF,KA1CD;;AA4CAL,QAAIM,EAAJ,CAAO,OAAP,EAAgB,eAAO;AACrB,YAAKD,IAAL,CAAU,OAAV,EAAmBa,GAAnB;AACD,KAFD;;AAIA;AACA;AACAnB,WAAOyB,IAAP,CAAYxB,GAAZ;AACD,GArIiD;AAsIlDmC,cAAY,oBAAS5D,OAAT,EAAkB6D,OAAlB,EAA2B;AACrC,QAAI7D,QAAQmB,OAAR,KAAoB,MAAxB,EAAgC;AAC9B,WAAKW,IAAL,CAAU,OAAV,EAAmB+B,OAAnB;AACD;AACF,GA1IiD;AA2IlDxB,kBAAgB,wBAASH,KAAT,EAAgBlC,OAAhB,EAAyB;AACvC,SAAK4D,UAAL,CAAgB5D,OAAhB,EAAyB,EAAC8D,MAAM,UAAP,EAAzB;AACA,SAAK3D,UAAL,CAAgB4D,WAAhB,CAA4B7B,KAA5B;AACD,GA9IiD;AA+IlDI,uBAAqB,6BAASJ,KAAT,EAAgBlC,OAAhB,EAAyB;AAC5C,SAAK4D,UAAL,CAAgB5D,OAAhB,EAAyB,EAAC8D,MAAM,gBAAP,EAAzB;AACA,QAAInC,OAAO,IAAX;AACA,QAAIP,gBAAgB,IAApB;AACA,YAAQpB,QAAQoB,aAAhB;AACE,WAAK,OAAL;AACEA,wBAAgB,KAAKA,aAAL,GAAqB,EAArC;AACA;AACF,WAAK,MAAL;AACE;AACF;AACEc,cAAME,SAAN;AACA;AARJ;;AAWA,QAAI4B,SAAS5E,IAAI6E,YAAJ,CAAiB,IAAjB,EAAuB,EAAvB,CAAb;AACA,QAAIC,MAAM,KAAV;AACA,QAAIC,IAAI,IAAR;AACA,QAAIC,QAAQ,CAAZ;AACAJ,WAAOjC,EAAP,CAAU,SAAV,EAAqB,UAASyB,IAAT,EAAe;AAClC,UAAIA,KAAKa,IAAL,KAAc,GAAlB,EAAuB;AACrBF,YAAI,IAAJ;AACAD,cAAM,IAAN;AACD;AACF,KALD;AAMAF,WAAOjC,EAAP,CAAU,UAAV,EAAsB,UAASsC,IAAT,EAAe;AACnC,UAAIH,OAAQG,SAAS,GAArB,EAA2B;AACzB,YAAIjD,aAAJ,EAAmB;AACjBA,wBAAc4B,IAAd,CAAmBmB,CAAnB;AACD,SAFD,MAEO;AACLxC,eAAKG,IAAL,CAAU,eAAV,EAA2B,EAAEsC,OAAOA,OAAT,EAAkBE,MAAMH,CAAxB,EAA3B;AACD;AACDA,YAAI,IAAJ;AACD;AACF,KATD;AAUAH,WAAOjC,EAAP,CAAU,MAAV,EAAkB,UAASuC,IAAT,EAAe;AAC/BH,UAAIA,IAAIA,IAAIG,IAAR,GAAeA,IAAnB;AACD,KAFD;AAGAN,WAAOjC,EAAP,CAAU,OAAV,EAAmB,UAASwC,KAAT,EAAgB;AACjC5C,WAAKG,IAAL,CAAU,OAAV,EAAmByC,KAAnB;AACD,KAFD;AAGArC,UAAMe,IAAN,CAAWe,MAAX;AACD,GAzLiD;AA0LlDzB,gBAAc,sBAASL,KAAT,EAAgBlC,OAAhB,EAAyB;AACrC,SAAK4D,UAAL,CAAgB5D,OAAhB,EAAyB,EAAC8D,MAAM,QAAP,EAAzB;AACA,QAAI9D,QAAQC,MAAR,KAAmB,OAAvB,EAAgC;AAC9BiC,YAAME,SAAN;AACA;AACD;AACD,SAAKnC,MAAL,GAAc,IAAIT,YAAJ,EAAd;AACA,SAAKS,MAAL,CAAY8D,WAAZ,CAAwB7B,KAAxB;AACD,GAlMiD;AAmMlDsC,cAAY,oBAASC,IAAT,EAAeC,UAAf,EAA2BzC,OAA3B,EAAoC;AAC9C,QAAIN,OAAO,IAAX;AACA,QAAIgD,SAASD,WAAWzC,OAAX,CAAb;AACA,QAAI,CAAC0C,MAAL,EAAa;AACXA,eAAS,IAAIF,IAAJ,CAAS,IAAT,EAAexC,OAAf,CAAT;AACAN,WAAKrB,OAAL;AACAqE,aAAO5C,EAAP,CAAU,UAAV,EAAsB,YAAW;AAC/B,YAAI,CAAC,GAAEJ,KAAKrB,OAAZ,EAAqB;AACnB,cAAIqB,KAAKpB,KAAT,EAAgB;AACdoB,iBAAKG,IAAL,CAAU,UAAV;AACD;AACF;AACF,OAND;AAOA4C,iBAAWzC,OAAX,IAAsB0C,MAAtB;AACD;AACD,WAAOA,MAAP;AACD,GAnNiD;AAoNlDnC,mBAAiB,yBAASN,KAAT,EAAgBD,OAAhB,EAAyBjC,OAAzB,EAAkC4B,QAAlC,EAA4C;AAC3D,SAAKgC,UAAL,CAAgB5D,OAAhB,EAAyB,EAAE8D,MAAM,WAAR,EAAqBc,IAAI3C,OAAzB,EAAzB;AACA,QAAI4C,kBAAkB,KAAKL,UAAL,CAAgB9E,eAAhB,EAAiC,KAAKU,gBAAtC,EAAwD6B,OAAxD,CAAtB;AACA,QAAIjC,QAAQsB,UAAR,KAAuB,MAA3B,EAAmC;AACjC,WAAKQ,IAAL,CAAU,WAAV,EAAuB+C,eAAvB;AACD;AACDA,oBAAgBtD,IAAhB,CAAqBW,KAArB,EAA4BlC,OAA5B,EAAqC,KAAKK,gBAAL,CAAsB4B,OAAtB,CAArC,EAAqEL,QAArE;AACA,WAAOiD,eAAP;AACD,GA5NiD;AA6NlD3B,oBAAkB,0BAAShB,KAAT,EAAgBD,OAAhB,EAAyBjC,OAAzB,EAAkC4B,QAAlC,EAA4C;AAC5D,SAAKgC,UAAL,CAAgB5D,OAAhB,EAAyB,EAAE8D,MAAM,WAAR,EAAqBc,IAAI3C,OAAzB,EAAzB;AACA,QAAI6C,mBAAmB,KAAKN,UAAL,CAAgB7E,eAAhB,EAAiC,KAAKU,gBAAtC,EAAwD4B,OAAxD,CAAvB;AACA,QAAIjC,QAAQqB,UAAR,KAAuB,MAA3B,EAAmC;AACjC,WAAKS,IAAL,CAAU,YAAV,EAAwBgD,gBAAxB;AACD;AACDA,qBAAiBvD,IAAjB,CAAsBW,KAAtB,EAA6BlC,OAA7B,EAAsC4B,QAAtC;AACD;AApOiD,CAApD","file":"workbook-reader.js","sourcesContent":["/**\n * Copyright (c) 2015-2017 Guyon Roche\n * LICENCE: MIT - please refer to LICENCE file included with this module\n * or https://github.com/guyonroche/exceljs/blob/master/LICENSE\n */\n\n'use strict';\n\nvar fs = require('fs');\nvar events = require('events');\nvar Stream = require('stream');\nvar unzip = require('unzipper');\nvar Sax = require('sax');\nvar tmp = require('tmp');\n\nvar utils = require('../../utils/utils');\nvar FlowControl = require('../../utils/flow-control');\n\nvar StyleManager = require('../../xlsx/xform/style/styles-xform');\nvar WorkbookPropertiesManager = require('../../xlsx/xform/book/workbook-properties-xform');\n\nvar WorksheetReader = require('./worksheet-reader');\nvar HyperlinkReader = require('./hyperlink-reader');\n\ntmp.setGracefulCleanup();\n\nvar WorkbookReader = module.exports = function(options) {\n  this.options = options = options || {};\n\n  this.styles = new StyleManager();\n  this.styles.init();\n\n  this.properties = new WorkbookPropertiesManager();\n\n  // worksheet readers, indexed by sheetNo\n  this.worksheetReaders = {};\n\n  // hyperlink readers, indexed by sheetNo\n  this.hyperlinkReaders = {};\n\n  // count the open readers\n  this.readers = 0;\n\n  // end of stream check\n  this.atEnd = false;\n\n  // worksheets, deferred for parsing after shared strings reading\n  this.waitingWorkSheets = [];\n\n  // callbacks for temp files cleanup\n  this.tempFileCleanupCallbacks = [];\n};\n\nutils.inherits(WorkbookReader, events.EventEmitter, {\n  _getStream: function(input) {\n    if (input instanceof Stream.Readable) {\n      return input;\n    }\n    if (typeof input === 'string') {\n      return fs.createReadStream(input);\n    }\n    throw new Error('Could not recognise input');\n  },\n\n  get flowControl() {\n    if (!this._flowControl) {\n      this._flowControl = new FlowControl(this.options);\n    }\n    return this._flowControl;\n  },\n\n  options: {\n    entries: ['emit'],\n    sharedStrings: ['cache', 'emit'],\n    styles: ['cache'],\n    hyperlinks: ['cache', 'emit'],\n    worksheets: ['emit']\n  },\n  read: function(input, options) {\n    var stream = this.stream = this._getStream(input);\n    var zip = this.zip = unzip.Parse();\n    var self = this;\n\n    const saxClose = new events.EventEmitter();\n    stream.once('close', function() {\n      saxClose.emit('close');\n    });\n\n    zip.on('entry', entry => {\n      var match, sheetNo;\n      // console.log(entry.path);\n      switch (entry.path) {\n        case '_rels/.rels':\n        case 'xl/_rels/workbook.xml.rels':\n          entry.autodrain();\n          break;\n        case 'xl/workbook.xml':\n          this._parseWorkbook(entry, options);\n          break;\n        case 'xl/sharedStrings.xml':\n          this._parseSharedStrings(entry, options);\n          break;\n        case 'xl/styles.xml':\n          this._parseStyles(entry, options);\n          break;\n        default:\n          if (entry.path.match(/xl\\/worksheets\\/sheet\\d+[.]xml/)) {\n            match = entry.path.match(/xl\\/worksheets\\/sheet(\\d+)[.]xml/);\n            sheetNo = match[1];\n            if (this.sharedStrings) {\n              this._parseWorksheet(entry, sheetNo, options, saxClose);\n            } else {\n              // create temp file for each worksheet\n              tmp.file(function _tempFileCreated(err, path, fd, cleanupCallback) {\n                if (err) throw err;\n\n                var tempStream = fs.createWriteStream(path);\n\n                self.waitingWorkSheets.push({sheetNo: sheetNo, options: options, path: path});\n                entry.pipe(tempStream);\n\n                self.tempFileCleanupCallbacks.push(cleanupCallback);\n              });\n            }\n          } else if (entry.path.match(/xl\\/worksheets\\/_rels\\/sheet\\d+[.]xml.rels/)) {\n            match = entry.path.match(/xl\\/worksheets\\/_rels\\/sheet(\\d+)[.]xml.rels/);\n            sheetNo = match[1];\n            this._parseHyperlinks(entry, sheetNo, options, saxClose);\n          } else {\n            entry.autodrain();\n          }\n          break;\n      }\n    });\n\n    zip.on('close', () => {\n      if (self.waitingWorkSheets.length) {\n          var currentBook = 0;\n\n          var processBooks = function () {\n              var worksheetInfo = self.waitingWorkSheets[currentBook];\n              var entry = fs.createReadStream(worksheetInfo.path);\n\n              var sheetNo = worksheetInfo.sheetNo;\n              var options = worksheetInfo.options;\n              var worksheet = self._parseWorksheet(entry, sheetNo, options, saxClose);\n\n              worksheet.on('finished', function (node) {\n                  ++currentBook;\n                  if (currentBook === self.waitingWorkSheets.length) {\n                    // temp files cleaning up\n                    self.tempFileCleanupCallbacks.forEach(function (cb) {\n                      cb();\n                    });\n\n                    self.tempFileCleanupCallbacks = [];\n\n                    self.emit('end');\n                    self.atEnd = true;\n                    if (!self.readers) {\n                      self.emit('finished');\n                    }\n                  } else {\n                      setImmediate(processBooks);\n                  }\n              })\n          }\n          setImmediate(processBooks);\n      } else {\n          this.emit('end');\n          this.atEnd = true;\n          if (!this.readers) {\n              this.emit('finished');\n          }\n      }\n\n\n    });\n\n    zip.on('error', err => {\n      this.emit('error', err);\n    });\n\n    // Pipe stream into top flow-control\n    // this.flowControl.pipe(zip);\n    stream.pipe(zip);\n  },\n  _emitEntry: function(options, payload) {\n    if (options.entries === 'emit') {\n      this.emit('entry', payload);\n    }\n  },\n  _parseWorkbook: function(entry, options) {\n    this._emitEntry(options, {type: 'workbook'});\n    this.properties.parseStream(entry);\n  },\n  _parseSharedStrings: function(entry, options) {\n    this._emitEntry(options, {type: 'shared-strings'});\n    var self = this;\n    var sharedStrings = null;\n    switch (options.sharedStrings) {\n      case 'cache':\n        sharedStrings = this.sharedStrings = [];\n        break;\n      case 'emit':\n        break;\n      default:\n        entry.autodrain();\n        return;\n    }\n\n    var parser = Sax.createStream(true, {});\n    var inT = false;\n    var t = null;\n    var index = 0;\n    parser.on('opentag', function(node) {\n      if (node.name === 't') {\n        t = null;\n        inT = true;\n      }\n    });\n    parser.on('closetag', function(name) {\n      if (inT && (name === 't')) {\n        if (sharedStrings) {\n          sharedStrings.push(t);\n        } else {\n          self.emit('shared-string', { index: index++, text: t});\n        }\n        t = null;\n      }\n    });\n    parser.on('text', function(text) {\n      t = t ? t + text : text;\n    });\n    parser.on('error', function(error) {\n      self.emit('error', error);\n    });\n    entry.pipe(parser);\n  },\n  _parseStyles: function(entry, options) {\n    this._emitEntry(options, {type: 'styles'});\n    if (options.styles !== 'cache') {\n      entry.autodrain();\n      return;\n    }\n    this.styles = new StyleManager();\n    this.styles.parseStream(entry);\n  },\n  _getReader: function(Type, collection, sheetNo) {\n    var self = this;\n    var reader = collection[sheetNo];\n    if (!reader) {\n      reader = new Type(this, sheetNo);\n      self.readers++;\n      reader.on('finished', function() {\n        if (!--self.readers) {\n          if (self.atEnd) {\n            self.emit('finished');\n          }\n        }\n      });\n      collection[sheetNo] = reader;\n    }\n    return reader;\n  },\n  _parseWorksheet: function(entry, sheetNo, options, saxClose) {\n    this._emitEntry(options, { type: 'worksheet', id: sheetNo });\n    var worksheetReader = this._getReader(WorksheetReader, this.worksheetReaders, sheetNo);\n    if (options.worksheets === 'emit') {\n      this.emit('worksheet', worksheetReader);\n    }\n    worksheetReader.read(entry, options, this.hyperlinkReaders[sheetNo], saxClose);\n    return worksheetReader;\n  },\n  _parseHyperlinks: function(entry, sheetNo, options, saxClose) {\n    this._emitEntry(options, { type: 'hyerlinks', id: sheetNo });\n    var hyperlinksReader = this._getReader(HyperlinkReader, this.hyperlinkReaders, sheetNo);\n    if (options.hyperlinks === 'emit') {\n      this.emit('hyperlinks', hyperlinksReader);\n    }\n    hyperlinksReader.read(entry, options, saxClose);\n  }\n});\n"]}